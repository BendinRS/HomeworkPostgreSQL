---
- name: update yum ca—Åhe
  yum:
    update_cache: true

# - name: Extract file
#   fetch:
#     src: /var/lib/pgsql/12/data/{{ item }}
#     dest: ./
#   with_items:
#   - postgresql.conf
#   - pg_hba.conf 

- name: Add PostgreSQL12 Repo
  yum:
    name:
      - http://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
    state: present

- name: Install PostgreSQL12
  yum:
    name: 
      - postgresql12-server
    state: present

- name: Initialize database
  shell: /usr/pgsql-12/bin/postgresql-12-setup initdb 
  ignore_errors: True
  #when: (ansible_hostname == "master")

- name: copy files conf
  copy: 
    src=files/{{ item }}
    dest=/var/lib/pgsql/12/data/{{ item }}
  with_items:
  - postgresql.conf
  - pg_hba.conf 
  when: (ansible_hostname == "master")


- name: started service postgresql
  systemd:
    name: postgresql-12
    enabled: yes
    state: started

- name: create barman user
  shell: psql -U postgres -d postgres -c "Create user barman superuser  password 'barman';"
  ignore_errors: True
  when: (ansible_hostname == "master")

- name: create slave user
  shell: psql -U postgres -d postgres -c "Create user slave replication  password 'slave';"
  ignore_errors: True
  when: (ansible_hostname == "master")

- name: delete files in slave
  shell: rm -rf /var/lib/postgresql/12/main/
  when: (ansible_hostname == "slave")

- include_role:
    name: barman


